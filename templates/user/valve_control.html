{% extends "shared/base.html" %}

{% block page_title %}Valve Control{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Valve Control</h2>
            
            <div class="mb-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">Current Status</h3>
                        <p class="text-gray-600" id="valve-status">{{ valve_status|title }}</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-700">Remaining Balance</h3>
                        <p class="text-gray-600" id="remaining-balance">{{ "%.2f"|format(remaining_balance) }} cubic meters</p>
                    </div>
                </div>
            </div>

            <div class="flex space-x-4">
                <button 
                    id="open-button"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    {% if valve_status == 'open' or not has_balance %}disabled{% endif %}
                    onclick="controlValve('open')">
                    Open Valve
                </button>
                
                <button 
                    id="close-button"
                    class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    {% if valve_status == 'closed' %}disabled{% endif %}
                    onclick="controlValve('close')">
                    Close Valve
                </button>
            </div>
        </div>
    </div>
</div>

<script>
async function controlValve(action) {
    try {
        const response = await fetch("{{ url_for('api_valve_control') }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                action: action,
                counter_id: "{{ current_user.counter_id }}"
            })
        });

        const data = await response.json();

        if (data.success) {
            document.getElementById('valve-status').innerText = data.status.charAt(0).toUpperCase() + data.status.slice(1);

            const openButton = document.getElementById('open-button');
            const closeButton = document.getElementById('close-button');

            if (data.status === 'open') {
                openButton.disabled = true;
                closeButton.disabled = false;
            } else if (data.status === 'close') {
                openButton.disabled = false;
                closeButton.disabled = true;
            }
        } else {
            alert(data.message);
        }
    } catch (error) {
        console.error(error);
        alert('Something went wrong.');
    }
}
</script>
{% endblock %}
